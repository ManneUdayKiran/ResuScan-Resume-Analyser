name: API Documentation

on:
  push:
    branches: [main, master]
    paths:
      - "backend/**"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend
          pip install -r requirements.txt
          pip install pdoc3

      - name: Download NLP models
        run: |
          python -m spacy download en_core_web_sm || true
          python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')" || true
        continue-on-error: true

      - name: Generate OpenAPI JSON
        run: |
          cd backend
          python -c "
          import json
          from main import app
          openapi_schema = app.openapi()
          with open('openapi.json', 'w') as f:
              json.dump(openapi_schema, f, indent=2)
          print('âœ… OpenAPI schema generated')
          " || echo "OpenAPI generation skipped"
        continue-on-error: true

      - name: Generate HTML documentation
        run: |
          mkdir -p docs
          cd backend

          # Generate module documentation
          pdoc --html --output-dir ../docs main || echo "pdoc generation skipped"

          # Create index page
          cat > ../docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ResuScan API Documentation</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
                  h1 { color: #333; border-bottom: 3px solid #667eea; padding-bottom: 15px; }
                  h2 { color: #667eea; margin-top: 30px; }
                  a { color: #667eea; text-decoration: none; font-weight: 500; }
                  a:hover { text-decoration: underline; }
                  .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin: 5px 5px 5px 0; }
                  .badge-python { background: #3776ab; color: white; }
                  .badge-fastapi { background: #009688; color: white; }
                  ul { line-height: 2; }
                  code { background: #f4f4f4; padding: 2px 8px; border-radius: 4px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸ“„ ResuScan API Documentation</h1>
                  <p><span class="badge badge-python">Python 3.11</span> <span class="badge badge-fastapi">FastAPI</span></p>
                  
                  <h2>ðŸ”— Quick Links</h2>
                  <ul>
                      <li><a href="./main/index.html">ðŸ“š Module Documentation</a></li>
                      <li><a href="./openapi.json">ðŸ“‹ OpenAPI Schema (JSON)</a></li>
                  </ul>
                  
                  <h2>ðŸš€ API Endpoints</h2>
                  <p>Visit <code>/docs</code> on the running server for interactive Swagger UI documentation.</p>
                  
                  <h2>ðŸ“– About ResuScan</h2>
                  <p>ResuScan is a comprehensive resume analysis tool that helps job seekers optimize their resumes for Applicant Tracking Systems (ATS).</p>
              </div>
          </body>
          </html>
          EOF
        continue-on-error: true

      - name: Copy OpenAPI schema to docs
        run: |
          cp backend/openapi.json docs/ 2>/dev/null || echo "No OpenAPI schema to copy"
        continue-on-error: true

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/
          retention-days: 30

  # Uncomment below to deploy to GitHub Pages
  # deploy-pages:
  #   name: Deploy to GitHub Pages
  #   needs: generate-docs
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deployment.outputs.page_url }}
  #
  #   steps:
  #     - name: Download documentation
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: api-documentation
  #         path: docs
  #
  #     - name: Setup Pages
  #       uses: actions/configure-pages@v4
  #
  #     - name: Upload to Pages
  #       uses: actions/upload-pages-artifact@v3
  #       with:
  #         path: docs
  #
  #     - name: Deploy to GitHub Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v4
