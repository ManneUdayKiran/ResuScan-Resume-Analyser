name: Deploy

on:
  push:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    # Uncomment the environment line when you set up environments
    # environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed successfully"

      - name: Verify build
        run: |
          cd backend
          python -c "from main import app; print('‚úÖ FastAPI app ready for deployment')"

      # ============================================
      # RENDER DEPLOYMENT (Uncomment to enable)
      # ============================================
      # - name: Deploy to Render
      #   env:
      #     RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      #     RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      #   run: |
      #     curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
      #       -H "Authorization: Bearer ${RENDER_API_KEY}" \
      #       -H "Content-Type: application/json"

      # ============================================
      # RAILWAY DEPLOYMENT (Uncomment to enable)
      # ============================================
      # - name: Deploy to Railway
      #   uses: berviantoleo/railway-deploy@v1
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: backend

      # ============================================
      # HEROKU DEPLOYMENT (Uncomment to enable)
      # ============================================
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.12.14
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: "your-app-name"
      #     heroku_email: "your-email@example.com"
      #     appdir: "backend"

      - name: Deployment placeholder
        run: |
          echo "üöÄ Backend deployment workflow ready!"
          echo ""
          echo "To enable deployment, uncomment one of the deployment sections above"
          echo "and add the required secrets to your repository:"
          echo ""
          echo "For Render:"
          echo "  - RENDER_API_KEY"
          echo "  - RENDER_SERVICE_ID"
          echo ""
          echo "For Railway:"
          echo "  - RAILWAY_TOKEN"
          echo ""
          echo "For Heroku:"
          echo "  - HEROKU_API_KEY"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    # Uncomment the environment line when you set up environments
    # environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build for production
        run: |
          cd frontend
          npm run build
        env:
          CI: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: frontend/dist/
          retention-days: 7

      # ============================================
      # VERCEL DEPLOYMENT (Already configured via vercel.json)
      # This happens automatically when you push to the connected repo
      # ============================================

      # ============================================
      # NETLIFY DEPLOYMENT (Uncomment to enable)
      # ============================================
      # - name: Deploy to Netlify
      #   uses: nwtgck/actions-netlify@v2.1
      #   with:
      #     publish-dir: './frontend/dist'
      #     production-branch: main
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # ============================================
      # GITHUB PAGES DEPLOYMENT (Uncomment to enable)
      # ============================================
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./frontend/dist

      - name: Deployment status
        run: |
          echo "üöÄ Frontend build completed!"
          echo "üìÅ Build output is in frontend/dist/"
          echo ""
          echo "Your frontend is configured to deploy to Vercel automatically"
          echo "(via vercel.json in the frontend directory)"
          echo ""
          echo "Build size:"
          du -sh frontend/dist/

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "====================="
          echo ""
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo ""
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
          else
            echo "‚ö†Ô∏è Some deployments may need attention"
          fi
