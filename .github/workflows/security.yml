name: Security Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run security scan weekly on Sundays
    - cron: "0 0 * * 0"

jobs:
  dependency-audit:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Python dependency check
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Check Python dependencies
        run: |
          pip install pip-audit safety
          cd backend
          echo "üîí Python Dependency Audit (pip-audit)"
          echo "======================================="
          pip install -r requirements.txt
          pip-audit || echo "Audit completed with findings"
          echo ""
          echo "üõ°Ô∏è Safety Check"
          echo "==============="
          safety check --full-report || echo "Safety check completed"
        continue-on-error: true

      # Node.js dependency check
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check npm dependencies
        run: |
          cd frontend
          echo "üîí NPM Audit Report"
          echo "==================="
          npm ci
          npm audit --audit-level=moderate || echo "Audit completed with findings"
        continue-on-error: true

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          echo "üîç Checking for potential secrets..."
          # Check for common secret patterns
          if grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.py" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules | grep -v ".env" | head -20; then
            echo "‚ö†Ô∏è Potential secrets found (review manually)"
          else
            echo "‚úÖ No obvious secrets detected"
          fi
        continue-on-error: true

  sast-scan:
    name: Static Application Security Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Run Bandit (Python SAST)
        run: |
          pip install bandit
          cd backend
          echo "üîê Bandit Security Scan"
          echo "======================="
          bandit -r . -f txt -o bandit-results.txt || true
          cat bandit-results.txt
          echo ""
          echo "üìä Summary:"
          bandit -r . -f json | python -c "import sys,json; d=json.load(sys.stdin); print(f\"High: {len([i for i in d.get('results',[]) if i['issue_severity']=='HIGH'])} | Medium: {len([i for i in d.get('results',[]) if i['issue_severity']=='MEDIUM'])} | Low: {len([i for i in d.get('results',[]) if i['issue_severity']=='LOW'])}\")" || echo "Summary unavailable"
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run npm audit fix dry-run
        run: |
          cd frontend
          npm ci
          echo "üîß NPM Audit Fix Suggestions"
          echo "============================"
          npm audit fix --dry-run || echo "No auto-fixes available"
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            backend/bandit-results.txt
        continue-on-error: true

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check frontend licenses
        run: |
          cd frontend
          npm ci
          npx license-checker --summary || echo "License check completed"
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Check Python licenses
        run: |
          pip install pip-licenses
          cd backend
          pip install -r requirements.txt
          echo "üìú Python Package Licenses"
          echo "=========================="
          pip-licenses --format=markdown || echo "License check completed"
        continue-on-error: true
